name: Deploy to Oracle Cloud VM

on:
  workflow_run:
    workflows: ["Docker Build and Push to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Generate lowercase repository name
        id: repo
        run: echo "repository=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Deploy to Oracle Cloud VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # GitHub Container Registry ë¡œê·¸ì¸
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop pray-together-api || true
            docker rm pray-together-api || true
            
            # ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
            docker rmi ghcr.io/${{ steps.repo.outputs.repository }}:latest || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            docker pull ghcr.io/${{ steps.repo.outputs.repository }}:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ ì§ì ‘ ì£¼ì…)
            docker run -d \
              --name pray-together-api \
              --restart unless-stopped \
              --memory=600m \
              -p 8080:8080 \
              -v /home/ubuntu/log-pray:/root/log-pray \
              --log-driver json-file \
              --log-opt max-size=50m \
              --log-opt max-file=10 \
              -e ORACLE_DB_DRIVER="${{ secrets.ORACLE_DB_DRIVER }}" \
              -e ORACLE_DB_URL="${{ secrets.ORACLE_DB_URL }}" \
              -e ORACLE_DB_USERNAME="${{ secrets.ORACLE_DB_USERNAME }}" \
              -e ORACLE_DB_PASSWORD="${{ secrets.ORACLE_DB_PASSWORD }}" \
              -e ORACLE_DB_DIALECT="${{ secrets.ORACLE_DB_DIALECT }}" \
              -e MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}" \
              -e MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e ACCESS_EXPIRE_TIME="${{ secrets.ACCESS_EXPIRE_TIME }}" \
              -e REFRESH_EXPIRE_TIME="${{ secrets.REFRESH_EXPIRE_TIME }}" \
              ghcr.io/${{ steps.repo.outputs.repository }}:latest
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ==="
            docker ps | grep pray-together-api || echo "ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
            
            # ë¡œê·¸ í™•ì¸ (ì‹œì‘ ë¶€ë¶„ë§Œ)
            echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë¡œê·¸ ==="
            sleep 30
            docker logs pray-together-api | head -20

      - name: Health Check and Verify Deployment
        id: health_check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ==="
            if ! docker ps -f name=pray-together-api | grep -q pray-together-api; then
              echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜ ì •ì˜
            check_health() {
              local max_attempts=5
              local attempt=1
            
              while [ $attempt -le $max_attempts ]; do
                echo "Health check attempt $attempt/$max_attempts..."
            
                # curlë¡œ í—¬ìŠ¤ì²´í¬ ìš”ì²­ (íƒ€ì„ì•„ì›ƒ 20ì´ˆ)
                response=$(curl -s -w "%{http_code}" --connect-timeout 20 --max-time 20 http://localhost:8080/health 2>/dev/null || echo "000")
                http_code="${response: -3}"
                body="${response%???}"
            
                echo "HTTP Status: $http_code"
                echo "Response: $body"
            
                # HTTP ìƒíƒœì½”ë“œê°€ 200ì´ê³  ì‘ë‹µì— "healthy"ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if [ "$http_code" = "200" ] && echo "$body" | grep -q "healthy"; then
                  echo "âœ… Health check passed! Service is healthy."
                  return 0
                fi
            
                echo "âŒ Health check failed. Retrying in 20 seconds..."
                sleep 20
                ((attempt++))
              done
            
              return 1
            }
            
            # í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
            if check_health; then
              echo "ğŸ‰ Deployment successful! Service is healthy."
            else
              echo "ğŸš¨ Deployment failed! Health check did not pass."
              echo "=== ìµœê·¼ ë¡œê·¸ í™•ì¸ ==="
              docker logs --tail=50 pray-together-api
              exit 1
            fi

      - name: Send Discord Success Notification
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          color: 0x00ff00
          title: "[${{ github.repository }}] ğŸš€ Deployment Successful"
          description: |
            Oracle Cloud VM deployment completed successfully!

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ steps.repo.outputs.repository }}:latest`
            **Port:** 8080
            **Health Check:** âœ… PASSED

            âœ… Application is running and responding to health checks!
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "ê¸°ë„í•¨ê»˜ ë„ìš°ë¯¸"

      - name: Send Discord Failure Notification
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          color: 0xff0000
          title: "[${{ github.repository }}] âŒ Deployment Failed"
          description: |
            Oracle Cloud VM deployment failed!

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ steps.repo.outputs.repository }}:latest`
            **Port:** 8080
            **Health Check:** âŒ FAILED

            âŒ Application is not responding to health checks. Please check the logs and container status.
            
            **Possible issues:**
            - Service failed to start properly
            - Health endpoint is not accessible
            - Database connection issues
            - Memory/Resource constraints
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "ê¸°ë„í•¨ê»˜ ë„ìš°ë¯¸"