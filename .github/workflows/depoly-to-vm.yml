name: Deploy to Oracle Cloud VM

on:
  workflow_run:
    workflows: ["Docker Build and Push to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Generate lowercase repository name
        id: repo
        run: echo "repository=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Deploy to Oracle Cloud VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # GitHub Container Registry Î°úÍ∑∏Ïù∏
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú
            docker stop pray-together-api || true
            docker rm pray-together-api || true
            
            # Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
            docker rmi ghcr.io/${{ steps.repo.outputs.repository }}:latest || true
            
            # ÏµúÏã† Ïù¥ÎØ∏ÏßÄ Pull
            docker pull ghcr.io/${{ steps.repo.outputs.repository }}:latest
            
            # Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ (ÌôòÍ≤ΩÎ≥ÄÏàò ÏßÅÏ†ë Ï£ºÏûÖ)
            docker run -d \
              --name pray-together-api \
              --restart unless-stopped \
              --memory=600m \
              -p 8080:8080 \
              -v /home/ubuntu/log-pray:/root/log-pray \
              --log-driver json-file \
              --log-opt max-size=50m \
              --log-opt max-file=10 \
              -e ORACLE_DB_DRIVER="${{ secrets.ORACLE_DB_DRIVER }}" \
              -e ORACLE_DB_URL="${{ secrets.ORACLE_DB_URL }}" \
              -e ORACLE_DB_USERNAME="${{ secrets.ORACLE_DB_USERNAME }}" \
              -e ORACLE_DB_PASSWORD="${{ secrets.ORACLE_DB_PASSWORD }}" \
              -e ORACLE_DB_DIALECT="${{ secrets.ORACLE_DB_DIALECT }}" \
              -e MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}" \
              -e MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e ACCESS_EXPIRE_TIME="${{ secrets.ACCESS_EXPIRE_TIME }}" \
              -e REFRESH_EXPIRE_TIME="${{ secrets.REFRESH_EXPIRE_TIME }}" \
              ghcr.io/${{ steps.repo.outputs.repository }}:latest
            
            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo "=== Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏ ==="
            docker ps | grep pray-together-api || echo "Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ Ïã§Ìå®"
            
            # Î°úÍ∑∏ ÌôïÏù∏ (ÏãúÏûë Î∂ÄÎ∂ÑÎßå)
            echo "=== Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë Î°úÍ∑∏ ==="
            sleep 30
            docker logs pray-together-api | head -20

      - name: Health Check and Verify Deployment
        id: health_check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo "=== Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏ ==="
            if ! docker ps -f name=pray-together-api | grep -q pray-together-api; then
              echo "‚ùå Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§ÌñâÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
              exit 1
            fi
            
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ìï®Ïàò Ï†ïÏùò
            check_health() {
              local max_attempts=5
              local attempt=1
            
              while [ $attempt -le $max_attempts ]; do
                echo "Health check attempt $attempt/$max_attempts..."
            
                # curlÎ°ú Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏöîÏ≤≠ (ÌÉÄÏûÑÏïÑÏõÉ 20Ï¥à)
                response=$(curl -s -w "%{http_code}" --connect-timeout 20 --max-time 20 http://localhost:8080/health 2>/dev/null || echo "000")
                http_code="${response: -3}"
                body="${response%???}"
            
                echo "HTTP Status: $http_code"
                echo "Response: $body"
            
                # HTTP ÏÉÅÌÉúÏΩîÎìúÍ∞Ä 200Ïù¥Í≥† ÏùëÎãµÏóê "healthy"Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                if [ "$http_code" = "200" ] && echo "$body" | grep -q "healthy"; then
                  echo "‚úÖ Health check passed! Service is healthy."
                  return 0
                fi
            
                echo "‚ùå Health check failed. Retrying in 20 seconds..."
                sleep 20
                ((attempt++))
              done
            
              return 1
            }
            
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìñâ
            if check_health; then
              echo "üéâ Deployment successful! Service is healthy."
              echo "DEPLOYMENT_STATUS=success" >> $GITHUB_ENV
            else
              echo "üö® Deployment failed! Health check did not pass."
              echo "=== ÏµúÍ∑º Î°úÍ∑∏ ÌôïÏù∏ ==="
              docker logs --tail=50 pray-together-api
              echo "DEPLOYMENT_STATUS=failed" >> $GITHUB_ENV
              exit 1
            fi

      - name: Send Discord Success Notification
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: success
          color: 0x00ff00
          title: "[${{ github.repository }}] üöÄ Deployment Successful"
          description: |
            Oracle Cloud VM deployment completed successfully!

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ steps.repo.outputs.repository }}:latest`
            **Port:** 8080
            **Health Check:** ‚úÖ PASSED

            ‚úÖ Application is running and responding to health checks!
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "Í∏∞ÎèÑÌï®Íªò ÎèÑÏö∞ÎØ∏"

      - name: Send Discord Failure Notification
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          color: 0xff0000
          title: "[${{ github.repository }}] ‚ùå Deployment Failed"
          description: |
            Oracle Cloud VM deployment failed!

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ steps.repo.outputs.repository }}:latest`
            **Port:** 8080
            **Health Check:** ‚ùå FAILED

            ‚ùå Application is not responding to health checks. Please check the logs and container status.
            
            **Possible issues:**
            - Service failed to start properly
            - Health endpoint is not accessible
            - Database connection issues
            - Memory/Resource constraints
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "Í∏∞ÎèÑÌï®Íªò ÎèÑÏö∞ÎØ∏"