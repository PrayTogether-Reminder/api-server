name: Deploy to Oracle Cloud VM

on:
  workflow_run:
    workflows: ["Docker Build and Push to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy to Oracle Cloud VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # GitHub Container Registry ë¡œê·¸ì¸
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop pray-together-api || true
            docker rm pray-together-api || true
            
            # ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ (ì„ íƒì‚¬í•­)
            docker rmi ghcr.io/${{ github.repository }}:latest || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            docker pull ghcr.io/${{ github.repository }}:latest
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              --name pray-together-api \
              --restart unless-stopped \
              --memory=600m \
              -p 8080:8080 \
              ghcr.io/${{ github.repository }}:latest

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sleep 10
            docker ps -f name=pray-together-api
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ (ì„ íƒì‚¬í•­)
            curl -f http://localhost:8080/actuator/health || echo "Health check failed"

      - name: Send Discord Deployment Status
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
          title: "[${{ github.repository }}] ${{ job.status == 'success' && 'ğŸš€ Deployment Successful' || 'âŒ Deployment Failed' }}"
          description: |
            Oracle Cloud VM deployment status for **${{ github.repository }}**.

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ github.repository }}:latest`
            **Port:** 8080

            ${{ job.status == 'success' && 'âœ… Application is running successfully!' || 'âŒ Deployment failed! Please check the logs.' }}
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "ê¸°ë„í•¨ê»˜ ë„ìš°ë¯¸"