name: Deploy to Oracle Cloud VM

on:
  workflow_run:
    workflows: ["Docker Build and Push to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Generate lowercase repository name
        id: repo
        run: echo "repository=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Deploy to Oracle Cloud VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # GitHub Container Registry ë¡œê·¸ì¸
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop pray-together-api || true
            docker rm pray-together-api || true
            
            # ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
            docker rmi ghcr.io/${{ steps.repo.outputs.repository }}:latest || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull
            docker pull ghcr.io/${{ steps.repo.outputs.repository }}:latest
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ ì§ì ‘ ì£¼ì…)
            docker run -d \
              --name pray-together-api \
              --restart unless-stopped \
              --memory=600m \
              -p 8080:8080 \
              -v /home/ubuntu/log-pray:/root/log-pray \
              --log-driver json-file \
              --log-opt max-size=50m \
              --log-opt max-file=10 \
              -e ORACLE_DB_DRIVER="${{ secrets.ORACLE_DB_DRIVER }}" \
              -e ORACLE_DB_URL="${{ secrets.ORACLE_DB_URL }}" \
              -e ORACLE_DB_USERNAME="${{ secrets.ORACLE_DB_USERNAME }}" \
              -e ORACLE_DB_PASSWORD="${{ secrets.ORACLE_DB_PASSWORD }}" \
              -e ORACLE_DB_DIALECT="${{ secrets.ORACLE_DB_DIALECT }}" \
              -e MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}" \
              -e MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              -e ACCESS_EXPIRE_TIME="${{ secrets.ACCESS_EXPIRE_TIME }}" \
              -e REFRESH_EXPIRE_TIME="${{ secrets.REFRESH_EXPIRE_TIME }}" \
              ghcr.io/${{ steps.repo.outputs.repository }}:latest
      
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ==="
            docker ps | grep pray-together-api || echo "ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
      
            # ë¡œê·¸ í™•ì¸ (ì‹œì‘ ë¶€ë¶„ë§Œ)
            echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë¡œê·¸ ==="
            sleep 10
            docker logs pray-together-api | head -20

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SUB_VM_HOST }}
          username: ${{ secrets.SUB_VM_USERNAME }}
          key: ${{ secrets.SUB_VM_SSH_KEY }}
          port: 22
          script: |
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sleep 10
            docker ps -f name=pray-together-api
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ (ì„ íƒì‚¬í•­)
            curl -f http://localhost:8080/actuator/health || echo "Health check failed"

      - name: Send Discord Deployment Status
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
          title: "[${{ github.repository }}] ${{ job.status == 'success' && 'ğŸš€ Deployment Successful' || 'âŒ Deployment Failed' }}"
          description: |
            Oracle Cloud VM deployment status for **${{ github.repository }}**.

            **Target:** Oracle Cloud VM
            **Image:** `ghcr.io/${{ steps.repo.outputs.repository }}:latest`
            **Port:** 8080

            ${{ job.status == 'success' && 'âœ… Application is running successfully!' || 'âŒ Deployment failed! Please check the logs.' }}
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          username: "ê¸°ë„í•¨ê»˜ ë„ìš°ë¯¸"